<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="Foredoomed">
  <meta name="generator" content="jekyll">
  <meta name="description" content="The homepage of Zhixingheyi">
  <link href="favicon.ico" rel="icon" type="image/x-icon" />
  <link rel="stylesheet" href="/css/highlight.css" type="text/css">
  <title></title>
</head>

<body>

<div style="width:700px">
  <h1>浏览器是如何工作的(八)</h1>

<em>By Foredoomed on <time date="2011-12-14 21:32:00 +0800">December 14, 2011</time></em>

<h3 id="section">4.3.3 简单规则匹配的例子</h3>

<p>样式规则有下面几种：</p>

<ul>
  <li>
    <p>CSS规则，外部表单或style元素</p>

    <p>p {color:blue}</p>
  </li>
  <li>
    <p>内联style属性</p>

    <p style="color:blue" />
  </li>
  <li>
    <p>HTML的视觉属性(会被映射到相关的样式规则)</p>

    <p bgcolor="blue" />
  </li>
</ul>

<p>后两种很容易和元素匹配，因为元素有style属性和HTML属性，他们可以用元素作为key来映射。</p>

<p>前面提到过的问题#2，CSS规则匹配可以是很复杂的。为了解决这个难题，所以对规则做一些处理，让获取规则更容易。</p>

<p>在解析样式表后，根据选择器规则会被加入到一个或多个hashmap中。这些map有以id为key的，有以class名key的，有以tag名为key的，还有一个通用map，它的key可以是任何类型。如果选择器是id选择器，那么规则会被加入到以id为key的map中，以此类推。</p>

<p>这个处理会使匹配规则变得更加容易。现在就没有必要查看每个定义，我们可以从map中得到相关的规则。这个优化消除了超过95%的规则，所以他们甚至在匹配过程中都不需要被考虑。</p>

<p>让我们看下面一个样式规则的例子：</p>

<pre><code>p.error {color:red}
#messageDiv {height:50px}
div {margin:5px}</code></pre>

<p>上面第一个规则会被插入到以class为key的map中，第二个规则会被插入到以id为key的map中，第三个规则会被插入到以tag名为key的map中。</p>

<p>对于下面的HTML片段：</p>

<pre><code>&lt;p class=&quot;error&quot;&gt;an error occurred &lt;/p&gt;
&lt;div id=&quot; messageDiv&quot;&gt;this is a message&lt;/div&gt;</code></pre>

<p>首先尝试寻找对应p元素的规则，在以class为key的map里找到一个以error为key的规则p.error。div元素在id的map和tag名的map中都有相关规则，所以剩下要做的只是找到哪个规则是真正匹配的规则。</p>

<p>例如下面的div样式规则：</p>

<pre><code>table div {margin:5px}</code></pre>

<p>更好匹配的是tag名的map，因为tag名是最右端的选择器，但是如果div元素没有table锚点的话就不会匹配。</p>

<p>Webkit和Firefox都会做这个处理。</p>

<h3 id="section-1">4.3.4 在正确的层级顺序中应用规则</h3>

<p>style对象有对应于视觉属性的属性，如果属性没有对应的规则，那么一些属性可以继承双亲元素的style对象，其他的属性有默认值。</p>

<p>当有多个定义的时候问题就来了，解决这个问题靠的是层级顺序。</p>

<h4 id="section-2">样式表的层级顺序</h4>

<p>style属性的声明可以在多个样式表中被声明，有时在一个样式表中，这意味着应用规则的顺序变得非常重要。这被称为层级顺序，根据CSS2的规范说明，层级顺序是(从低到高)：</p>

<ol>
  <li>浏览器定义</li>
  <li>用户普通定义</li>
  <li>开发者普通定义</li>
  <li>开发者重要定义</li>
  <li>用户重要定义</li>
</ol>

<p>浏览器定义是最不重要的，用户定义的样式如果被标记为重要的就可以覆盖开发者定义的样式。如果是相同顺序的定义会被<a href="http://www.html5rocks.com/en/tutorials/internals/howbrowserswork/#Specificity" title="specificity">特征(specificity)</a>排序，经过排序后的顺序是特征化的。HTML视觉属性被翻译成匹配的CSS声明，他们是以低优先级的开发者规则被对待的。</p>

<h4 id="specificity">特征(Specificity)</h4>

<p>选择器的特征在<a href="http://www.w3.org/TR/CSS2/cascade.html#specificity" title="CSS2">CSS2规范</a>中被定义为：</p>

<ul>
  <li>如果样式声明是从style属性中来，而不是一个选择器的规则，那么特征就为1，否则就为0(= a)</li>
  <li>计算选择器的ID属性的数量(= b)</li>
  <li>计算选择器中其他属性和pseudo-class的数量(= c)</li>
  <li>计算选择器中元素名和pseudo-element的数量(= d)</li>
</ul>

<p>最后特征值就是把上面四个数字连起来：a-b-c-d</p>

<p>数的进制是上面四个数的最大值决定的。例如，如果a = 14，那么就可以使用16进制；而如果a = 17的话，就需要使用18或更高进制。后一种情况在选择器类似于html body div div p … 的情况下会发生。</p>

<p>一些例子：</p>

<pre><code>*             {}  /* a=0 b=0 c=0 d=0 -&gt; specificity = 0,0,0,0 */
 li            {}  /* a=0 b=0 c=0 d=1 -&gt; specificity = 0,0,0,1 */
 li:first-line {}  /* a=0 b=0 c=0 d=2 -&gt; specificity = 0,0,0,2 */
 ul li         {}  /* a=0 b=0 c=0 d=2 -&gt; specificity = 0,0,0,2 */
 ul ol+li      {}  /* a=0 b=0 c=0 d=3 -&gt; specificity = 0,0,0,3 */
 h1 + *[rel=up]{}  /* a=0 b=0 c=1 d=1 -&gt; specificity = 0,0,1,1 */
 ul ol li.red  {}  /* a=0 b=0 c=1 d=3 -&gt; specificity = 0,0,1,3 */
 li.red.level  {}  /* a=0 b=0 c=2 d=1 -&gt; specificity = 0,0,2,1 */
 #x34y         {}  /* a=0 b=1 c=0 d=0 -&gt; specificity = 0,1,0,0 */
 style=&quot;&quot;          /* a=1 b=0 c=0 d=0 -&gt; specificity = 1,0,0,0 */</code></pre>

<h4 id="section-3">规则排序</h4>

<p>在所有的规则匹配之后，他们会根据层级规则被排序。Webkit使用冒泡排序法对小的集合排序，用归并排序法对大的集合排序。Webkit依靠重写&gt;操作符来实现排序：</p>

<pre><code>static bool operator &gt;(CSSRuleData&amp; r1, CSSRuleData&amp; r2)
{
    int spec1 = r1.selector()-&gt;specificity();
    int spec2 = r2.selector()-&gt;specificity();
    return (spec1 == spec2) : r1.position() &gt; r2.position() : spec1 &gt; spec2; 
}</code></pre>

<h2 id="section-4">4.4 渐进的过程</h2>

<p>Webkit使用一个标志来标记所有顶层样式表(包括@imports)被加载完成。如果在样式没有完全被加载时就去访问它，那么站位符就会被使并且在文档中被标记，在样式表被加载完成后重新计算。</p>



<br><br>

<div id="disqus_thread" style="width:700px"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'zhixingheyi'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<hr>

Zhixingheyi - <a href="http://liuxuan.info">http://liuxuan.info/</a>
</div>

<script src="/javascript/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17293168-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
  var sc_project=8495631;
  var sc_invisible=1;
  var sc_security="5b0817e1";
  var scJsHost = (("https:" == document.location.protocol) ?
  "https://secure." : "http://www.");
  document.write("<sc"+"ript type='text/javascript' src='" +
  scJsHost +
  "statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript>
  <div class="statcounter"><a title="website
  statistics" href="http://statcounter.com/"
  target="_blank"><img class="statcounter"
  src="https://c.statcounter.com/8495631/0/5b0817e1/1/"
  alt="website statistics"></a></div>
</noscript>
<!-- End of StatCounter Code for Default Guide -->

</body>
</html>